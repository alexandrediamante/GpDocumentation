<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador de Release Notes GP</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f0f2f5; }
    .container { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h2, h3 { color: #1a73e8; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
    label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
    select, textarea, input { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    button { margin-top: 20px; padding: 10px 20px; background: #1a73e8; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; transition: background-color 0.2s; }
    button:hover { background: #155ab6; }
    .item, .history-version { border: 1px solid #ddd; padding: 15px; margin-top: 15px; background: #fafafa; border-radius: 4px; }
    #output { white-space: pre-wrap; background: #e8f0fe; padding: 20px; margin-top: 20px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Courier New', Courier, monospace; }
    .tabs { display: flex; border-bottom: 1px solid #ccc; }
    .tab-button { padding: 10px 20px; cursor: pointer; background: #f0f2f5; border: none; border-bottom: 3px solid transparent; font-size: 1rem; }
    .tab-button.active { font-weight: bold; border-bottom: 3px solid #1a73e8; background: white; }
    .tab-content { display: none; padding-top: 20px; }
    .tab-content.active { display: block; }
    .delete-item-btn { color: #e53935; cursor: pointer; font-weight: bold; margin-left: 10px; display: inline-block; padding: 2px 5px; border-radius: 4px; }
    .delete-item-btn:hover { background-color: #ffcdd2; }
    .button-group { display: flex; gap: 10px; flex-wrap: wrap; }

    /* Estilos para o modo de visualiza√ß√£o */
    .view-mode .admin-only {
        display: none !important;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- As abas e o gerador s√£o vis√≠veis apenas no modo de administrador -->
  <div class="tabs admin-only">
    <button class="tab-button active" onclick="showTab('gerador')">üìù Gerador</button>
    <button class="tab-button" onclick="showTab('historico')">üìö Hist√≥rico</button>
  </div>

  <div id="gerador" class="tab-content active admin-only">
    <h2>üìù Gerador de Release Notes - GP.EXE</h2>
    
    <label for="versao">Vers√£o:</label>
    <input type="text" id="versao" placeholder="Ex: 3.0.401.0">

    <label for="data">Data de Libera√ß√£o:</label>
    <input type="date" id="data">

    <label for="tipo">Tipo de Release:</label>
    <select id="tipo">
      <option value="Master Stable Release">Release Est√°vel</option>
      <option value="Hotfix">Hotfix / Corre√ß√£o</option>
      <option value="Melhoria">Melhoria</option>
      <option value="Feature Release">Novas Funcionalidades</option>
    </select>

    <div id="itens-container">
      <h3>üìã Itens da Vers√£o</h3>
    </div>
    <button onclick="adicionarItem()">‚ûï Adicionar Item</button>
    <hr>
    <div class="button-group">
      <button onclick="gerarHTML()">üöÄ Gerar HTML</button>
      <button onclick="salvarVersao()">üíæ Salvar Vers√£o</button>
    </div>
    
    <h3>üìÑ HTML Gerado:</h3>
    <div id="output"></div>
  </div>

  <!-- O hist√≥rico √© vis√≠vel em ambos os modos -->
  <div id="historico" class="tab-content">
    <h2>üìö Hist√≥rico de Vers√µes</h2>
    <div id="history-container">
      <p>Carregando hist√≥rico...</p>
    </div>
  </div>
</div>

<script type="module">
  // 1. IMPORTA√á√ïES DO FIREBASE
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, getDocs, query, orderBy, doc, getDoc, updateDoc 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // 2. CONFIGURA√á√ÉO DO FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyDK34Eirz7vutvXQo9gwQlNM4mi_7YtBrE",
    authDomain: "gp-exe.firebaseapp.com",
    projectId: "gp-exe",
    storageBucket: "gp-exe.appspot.com",
    messagingSenderId: "333935319850",
    appId: "1:333935319850:web:94075ae2fe0b68978c1c53",
    measurementId: "G-JYQB1Q90VX"
  };

  // 3. INICIALIZA√á√ÉO
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const versoesCollection = collection(db, "versoes");
  const SENHA_MESTRA = "gpsemtreta";
  let contador = 0;

  // --- L√ìGICA DE MODO DE VISUALIZA√á√ÉO ---
  const isViewMode = window.location.hash === '#view';

  // --- FUN√á√ÉO DE VERIFICA√á√ÉO DE SENHA ---
  function verificarSenha() {
    const senhaInserida = prompt("Para executar esta a√ß√£o, por favor, insira a senha:");
    if (senhaInserida !== SENHA_MESTRA) {
        if (senhaInserida !== null) {
            alert("Senha incorreta!");
        }
        return false;
    }
    return true;
  }

  // --- L√ìGICA DAS ABAS ---
  window.showTab = function(tabName) {
    if (isViewMode) return; // Impede a troca de abas no modo de visualiza√ß√£o

    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');

    if (tabName === 'historico') {
      carregarHistorico();
    }
  }

  // --- L√ìGICA DO GERADOR ---
  window.adicionarItem = function() {
    contador++;
    const container = document.getElementById('itens-container');
    const div = document.createElement('div');
    div.className = 'item';
    div.id = `item_novo_${contador}`;
    div.innerHTML = `
      <label>Tipo:</label>
      <select id="tipo_novo_${contador}">
        <option value="Feature">Nova Funcionalidade</option>
        <option value="Bug">Corre√ß√£o de Bug</option>
        <option value="Ajuste">Melhoria / Ajuste</option>
      </select>
      <label>T√≠tulo:</label>
      <input type="text" id="titulo_novo_${contador}" placeholder="Ex: Feature #12345 - Nova tela de v√≠nculos">
      <label>Descri√ß√£o:</label>
      <textarea id="descricao_novo_${contador}" rows="4" placeholder="Descreva aqui..."></textarea>
    `;
    container.appendChild(div);
  }

  function getDadosFormulario() {
    const versao = document.getElementById('versao').value;
    const data = document.getElementById('data').value;
    const tipoRelease = document.getElementById('tipo').value;

    const itens = [];
    for (let i = 1; i <= contador; i++) {
        if(document.getElementById(`item_novo_${i}`)){
            const tipoItem = document.getElementById(`tipo_novo_${i}`).value;
            const titulo = document.getElementById(`titulo_novo_${i}`).value;
            const desc = document.getElementById(`descricao_novo_${i}`).value;
            itens.push({ tipo: tipoItem, titulo: titulo, descricao: desc });
        }
    }
    return { versao, data, tipoRelease, itens, timestamp: new Date() };
  }

  window.gerarHTML = function() {
    const dados = getDadosFormulario();
    let html = `<h2>‚ôªÔ∏è Nova vers√£o de produ√ß√£o <strong>${dados.versao || '?.?.?.?'}</strong> ‚Äì ${dados.tipoRelease}</h2>`;
    html += `<p><strong>üìÖ Data da Libera√ß√£o:</strong> ${dados.data || 'N√£o definida'}</p>`;
    html += `<p><strong>üßæ Vers√£o do Execut√°vel:</strong> gp.exe</p>`;
    html += `<hr><h3>‚úÖ Itens inclu√≠dos nesta vers√£o:</h3>`;

    dados.itens.forEach(item => {
      const icone = item.tipo === "Feature" ? "üîπ" : item.tipo === "Bug" ? "üî∏" : "üõ†Ô∏è";
      html += `<p>${icone} <strong>${item.titulo}</strong><br>${item.descricao.replace(/\n/g, '<br>')}</p>`;
    });

    document.getElementById('output').innerHTML = html;
  }
  
  // --- FUN√á√ïES DE BANCO DE DADOS ---

  window.salvarVersao = async function() {
    if (!verificarSenha()) return;

    const dados = getDadosFormulario();
    if (!dados.versao || !dados.data || dados.itens.length === 0) {
      alert("Por favor, preencha a Vers√£o, a Data e adicione pelo menos um item.");
      return;
    }

    try {
      await addDoc(versoesCollection, dados);
      alert(`Vers√£o ${dados.versao} salva com sucesso!`);
      document.getElementById('versao').value = '';
      document.getElementById('data').valueAsDate = new Date();
      document.getElementById('itens-container').innerHTML = '<h3>üìã Itens da Vers√£o</h3>';
      document.getElementById('output').innerHTML = '';
      contador = 0;
    } catch (error) {
      console.error("Erro ao salvar a vers√£o: ", error);
      alert("Ocorreu um erro ao salvar a vers√£o.");
    }
  }

  async function carregarHistorico() {
    const historyContainer = document.getElementById('history-container');
    historyContainer.innerHTML = '<p>Carregando hist√≥rico...</p>';

    try {
      const q = query(versoesCollection, orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      
      if (snapshot.empty) {
        historyContainer.innerHTML = '<p>Nenhuma vers√£o encontrada no hist√≥rico.</p>';
        return;
      }
      
      let html = '';
      snapshot.forEach(docSnapshot => {
        const versao = docSnapshot.data();
        const versaoId = docSnapshot.id;
        
        html += `<div class="history-version">`;
        html += `<h3>Vers√£o: ${versao.versao} (${versao.tipoRelease}) - ${versao.data}</h3>`;
        if (versao.itens && versao.itens.length > 0) {
            versao.itens.forEach((item, index) => {
              const icone = item.tipo === "Feature" ? "üîπ" : item.tipo === "Bug" ? "üî∏" : "üõ†Ô∏è";
              html += `<p>${icone} <strong>${item.titulo}</strong><br>${item.descricao.replace(/\n/g, '<br>')}`;
              // Adiciona o bot√£o de deletar apenas se N√ÉO estiver no modo de visualiza√ß√£o
              if (!isViewMode) {
                html += ` <span class="delete-item-btn" onclick="deletarItem('${versaoId}', ${index})">‚ùå</span>`;
              }
              html += `</p>`;
            });
        } else {
            html += `<p>Nenhum item nesta vers√£o.</p>`;
        }
        html += `</div>`;
      });
      historyContainer.innerHTML = html;

    } catch (error) {
      console.error("Erro ao carregar o hist√≥rico: ", error);
      historyContainer.innerHTML = '<p>Erro ao carregar o hist√≥rico. Verifique o console.</p>';
    }
  }
  window.carregarHistorico = carregarHistorico;

  window.deletarItem = async function(versaoId, itemIndex) {
    if (!verificarSenha()) return;
    if (!confirm("Tem certeza que deseja deletar este item? Esta a√ß√£o n√£o pode ser desfeita.")) return;

    try {
      const docRef = doc(db, "versoes", versaoId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) {
        alert("Erro: Vers√£o n√£o encontrada.");
        return;
      }
      let dadosDaVersao = docSnap.data();
      dadosDaVersao.itens.splice(itemIndex, 1);
      await updateDoc(docRef, { itens: dadosDaVersao.itens });
      alert("Item deletado com sucesso!");
      carregarHistorico();
    } catch (error) {
      console.error("Erro ao deletar o item: ", error);
      alert("Ocorreu um erro ao deletar o item.");
    }
  }

  // --- INICIALIZA√á√ÉO DA P√ÅGINA ---
  document.addEventListener('DOMContentLoaded', () => {
    if (isViewMode) {
        document.body.classList.add('view-mode');
        document.getElementById('historico').style.display = 'block';
        document.getElementById('gerador').style.display = 'none';
        carregarHistorico();
    } else {
        document.getElementById('data').valueAsDate = new Date();
        showTab('gerador');
    }
  });

</script>

</body>
</html>
